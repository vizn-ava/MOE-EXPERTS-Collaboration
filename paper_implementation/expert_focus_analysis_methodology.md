# 专家专注度分析方法论

## 1. 概述

专家专注度（Expert Focus Degree）是衡量混合专家模型（MoE）中每个专家在不同领域上专业化程度的重要指标。该指标反映了专家是否专注于特定领域，还是在多个领域间均匀分布其激活能力。

## 2. 分析流程

### 2.1 数据预处理

**步骤1：构建专家-Token映射**
- 输入：激活张量 `activations` (shape: [num_tokens, num_experts])
- 阈值过滤：只保留激活值 > `threshold` 的专家激活
- 输出：专家到Token列表的映射关系

**步骤2：领域偏好分析**
- 基于Token的领域标签，统计每个专家在各领域的激活情况
- 计算每个专家在每个领域的激活统计信息

### 2.2 专注度计算

## 3. 核心计算公式

### 3.1 领域激活统计

对于专家 $i$ 在领域 $d$ 的激活统计：

$$\text{DomainStats}_{i,d} = \{count_{i,d}, mean_{i,d}, max_{i,d}, total_{i,d}\}$$

其中：
- $count_{i,d}$：专家 $i$ 在领域 $d$ 中激活的Token数量
- $mean_{i,d}$：专家 $i$ 在领域 $d$ 中的平均激活值
- $max_{i,d}$：专家 $i$ 在领域 $d$ 中的最大激活值
- $total_{i,d}$：专家 $i$ 在领域 $d$ 中的总激活量

### 3.2 领域激活百分比

专家 $i$ 在领域 $d$ 的激活百分比：

$$P_{i,d} = \frac{total_{i,d}}{\sum_{d'=1}^{D} total_{i,d'}} \times 100\%$$

其中 $D$ 是总领域数。

### 3.3 专家专注度

专家 $i$ 的专注度定义为其最专注领域的激活百分比：

$$FocusDegree_i = \max_{d \in \{1,2,...,D\}} P_{i,d}$$

### 3.4 全局专注度指标

**平均专注度：**
$$\overline{FocusDegree} = \frac{1}{N} \sum_{i=1}^{N} FocusDegree_i$$

**专注度标准差：**
$$\sigma_{FocusDegree} = \sqrt{\frac{1}{N} \sum_{i=1}^{N} (FocusDegree_i - \overline{FocusDegree})^2}$$

其中 $N$ 是专家总数。

## 4. 算法实现

```python
def calculate_expert_focus_degree(expert_domain_stats):
    focus_degrees = []
    
    for expert_idx, domain_stats in expert_domain_stats.items():
        # 计算总激活量
        total_activation = sum(stats['total_activation'] 
                             for stats in domain_stats.values())
        
        if total_activation > 0:
            # 计算各领域百分比
            domain_percentages = {
                domain: (stats['total_activation'] / total_activation) * 100
                for domain, stats in domain_stats.items()
            }
            
            # 找到最大百分比作为专注度
            focus_degree = max(domain_percentages.values())
            focus_degrees.append(focus_degree)
    
    return focus_degrees
```

## 5. 实际案例

### 5.1 示例数据

假设我们有一个专家在3个领域的激活情况：

| 领域 | Token数量 | 总激活量 | 平均激活值 |
|------|-----------|----------|------------|
| 科学 | 150 | 45.2 | 0.301 |
| 文学 | 80 | 12.8 | 0.160 |
| 历史 | 120 | 18.6 | 0.155 |

### 5.2 计算过程

**步骤1：计算总激活量**
$$Total = 45.2 + 12.8 + 18.6 = 76.6$$

**步骤2：计算各领域百分比**
- 科学：$P_{science} = \frac{45.2}{76.6} \times 100\% = 59.0\%$
- 文学：$P_{literature} = \frac{12.8}{76.6} \times 100\% = 16.7\%$
- 历史：$P_{history} = \frac{18.6}{76.6} \times 100\% = 24.3\%$

**步骤3：确定专注度**
$$FocusDegree = \max(59.0\%, 16.7\%, 24.3\%) = 59.0\%$$

### 5.3 结果解释

该专家的专注度为59.0%，表明：
- 该专家主要专注于科学领域
- 专注程度中等（不是极度专注也不是完全分散）
- 在文学和历史领域也有一定的激活，但相对较少

## 6. 专注度分布分析

### 6.1 分布区间

我们将专注度分为5个区间：
- **极度分散** (0-20%)：专家在所有领域均匀分布
- **轻度专注** (20-40%)：专家有轻微的领域偏好
- **中度专注** (40-60%)：专家有明显的主要领域
- **高度专注** (60-80%)：专家主要专注于特定领域
- **极度专注** (80-100%)：专家几乎只激活于单一领域

### 6.2 统计指标

- **平均专注度**：反映整体模型的专业化程度
- **专注度标准差**：反映专家间专注程度的差异
- **分布直方图**：显示不同专注度区间的专家数量

## 7. 应用价值

### 7.1 模型分析
- **专业化程度评估**：了解模型是否学会了领域专业化
- **负载均衡分析**：检查专家使用是否均衡
- **模型优化指导**：为模型改进提供方向

### 7.2 实际意义
- **高专注度**：表明专家有明确的专业分工
- **低专注度**：可能表明专家功能重叠或训练不充分
- **适中专注度**：通常表明良好的专业化平衡

## 8. 参数设置

### 8.1 激活阈值 (activation_threshold)
- **推荐值**：0.01 - 0.3
- **影响**：
  - 较低阈值（0.01）：包含更多弱激活，分析更全面但计算量大
  - 较高阈值（0.3）：只关注强激活，计算快但可能丢失信息
  - 中等阈值（0.1）：平衡准确性和效率

### 8.2 领域定义
- 基于Token的元数据标签
- 可以是预定义的领域分类
- 也可以是动态聚类的结果

## 9. 局限性与改进方向

### 9.1 当前局限性
- 依赖于领域标签的质量
- 未考虑激活值的时序特性
- 简单的最大值选择可能忽略次要专长

### 9.2 改进方向
- 引入熵基的专注度度量
- 考虑激活值的分布特征
- 结合专家间的协作模式分析